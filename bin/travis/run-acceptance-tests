#!/bin/bash

# This script will assume the following pre-conditions are met
# - The development server for Flask is running at http://localhost:5000/

# This script will
# - Pull hello-world-node and hello-world-acceptance-tests from their repos
# - Update pip and install dependences for hello-world-acceptance-tests
# - Start the node development server
# - Wait for the node server to stabilize
# - Run the acceptance tests (behave)
# - Stop the development server
# - Return the exit status of behave.

# ------------------------------ Config ---------------------------------------
# URL of git repository for hello-world-node
HELLO_WORLD_NODE_REPO="https://github.com/taller2fiuba/hello-world-node.git"

# URL of git repository for hello-world-acceptance-tests
HELLO_WORLD_ACCEPTANCE_TESTS_REPO="https://github.com/taller2fiuba/hello-world-acceptance-tests.git"

# The node server will be considered to be up when this URL returns 200 OK.
DEV_SERVER_URL="http://localhost:27080"

# Timeout for the connection, in seconds
CONN_TIMEOUT=1

# Time to wait for next retry, in seconds
RETRY_TIME=1

# Binaries required for the script
GIT=git
PIP="sudo pip"
BEHAVE=behave

# ------------------------------ Setup ---------------------------------------
TMPDIR=$(mktemp -d -t ci-XXXXXXXXXX)
cd $TMPDIR

# Pull repositories
$GIT clone "$HELLO_WORLD_NODE_REPO"
$GIT clone "$HELLO_WORLD_ACCEPTANCE_TESTS_REPO"

# Update pip and install dependencies
$PIP install --upgrade pip
$PIP install -r hello-world-acceptance-tests/requirements.txt

# Start node server in the background
./hello-world-node/bin/start-test-server

# Wait for the server to stabilize
until curl -o /dev/null -s --connect-timeout $CONN_TIMEOUT $DEV_SERVER_URL; 
do 
    echo "Waiting $RETRY_TIME sec(s) for server to start"; 
    sleep $RETRY_TIME; 
done;

echo "Development server started on $DEV_SERVER_URL"

# ------------------------------- Run ----------------------------------------
echo 'Running acceptance tests'
cd hello-world-acceptance-tests

$BEHAVE
RETVAL=$?

cd ..
# ---------------------------- Tear down--------------------------------------
echo 'Stopping development server'
./hello-world-node/bin/stop-server;

exit $RETVAL